---
title: "Votes"
author: "Thais G. Veras Gama"
date: "21/06/2021"
output: html_document
---

```{r, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = "hide", fig.width = 15, fig.height = 15)


library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(geobr)
library(RColorBrewer)
library(crul)
library(readxl)
library(stringi)
library(gridExtra)
library(DT)
library(knitr)
library(kableExtra)
library(htmltools)
library(tinytex)

rm(list = ls ())

setwd("C:/Users/André/OneDrive/eleicoes_2020")
tabela<-read.csv("votacao_secao_2020_CE.csv",header = TRUE, sep = ";", encoding = "latin1")


fortal <- read_municipality(code_muni=2304400)
nei_br <- geobr::read_neighborhood()
nei_fortal <- subset(nei_br, name_muni=='Fortaleza')

```

## Vereadores Eleitos na cidade de Fortaleza

Esse documento busca detalhar a nível territorial os votos das eleições 2020 para Câmara Municipal de Fortaleza. São utilizadas duas variáveis, a primeira é o número de votos absolutos, ou seja, o total de votos que o candidato obteve por bairro. A segunda é a votação relativa, que considera a proporção de votos do candidato considerando o número de eleitores aptos nos respectivos bairros. 

Os espaços em branco nos mapas significam que não foram identificadas seções eleitorais naquela região.





```{r mapinha, results='asis'}


candidatos <- c("LUCIO ALBUQUERQUE BRUNO FIGUEIREDO", "JULIO BRIZZI NETO","ANTÔNIO HENRIQUE  DA SILVA", "ADAIL FERNANDES VIEIRA JUNIOR","GARDEL FERREIRA ROLIM","PAULO VICTOR ARAUJO MARTINS","ANA PAULA BRANDÃO DA SILVA FARIAS","ELPIDIO NOGUEIRA MOREIRA","RENAN EHRICH COLARES", "RAIMUNDO CUNHA FILHO")

for (i in candidatos)
  { 
  
candi <- dplyr::filter(tabela,NM_VOTAVEL==i)


setwd("C:/Users/André/OneDrive/eleicoes_2020")

tre_secoes <- read_excel("tre_secoes.xlsx")
colnames(tre_secoes)[2]<-"NR_ZONA"
colnames(tre_secoes)[3]<-"NR_SECAO"

tre_secoes <- tre_secoes %>% filter(Município=="FORTALEZA")

##UNINDO SECOES DO TRE E RESULTADO VOTACAO##

candi2<-full_join(candi,tre_secoes)

colnames(candi2)[28]<-"name_neighborhood"

##AJUSTANDO OS NOMES DO IBGE PARA COMBINAR COLUNAS##

nei_fortal$name_neighborhood <- toupper(nei_fortal$name_neighborhood)
nei_fortal$name_neighborhood <- stri_trans_general(nei_fortal$name_neighborhood, "Latin-ASCII")
candi2$name_neighborhood <- stri_trans_general(candi2$name_neighborhood, "Latin-ASCII")



nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="MESSEJANA (SEDE)"] <- "MESSEJANA"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="PICI (PARQUE UNIVERSITARIO)"] <- "PICI"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="MONDUBIM (SEDE)"] <- "MONDUBIM"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="PAN-AMERICANO"] <- "PAN AMERICANO"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="ESTANCIA (DIONISIO TORRES)"] <- "DIONISIO TORRES"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="VILA PERY"] <- "VILA PERI"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="AEROPORTO (BASE AEREA)"] <- "AEROPORTO"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="JOQUEI CLUB (SAO CRISTOVAO)"] <- "JOQUEI CLUBE"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="PADRE ANDRADE (CACHOEIRINHA)"] <- "PADRE ANDRADE"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="ARRAIAL MOURA BRASIL"] <- "MOURA BRASIL"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="LAGOA SAPIRANGA (COITE)"] <- "SAPIRANGA"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="GUAJERU"] <- "GUAJIRU"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="GENIBAU"] <- "PARQUE GENIBAU"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="MANOEL SATIRO"] <- "MANUEL SATIRO"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="PARQUE SANTA ROSA (APOLO XI)"] <- "PARQUE SANTA ROSA"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="AMADEO FURTADO"] <- "AMADEU FURTADO"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="CASTELAO"] <- "BOA VISTA"
nei_fortal$name_neighborhood[nei_fortal$name_neighborhood=="ALAGADICO"] <- "SAO GERARDO"


candi2$name_neighborhood[candi2$name_neighborhood=="PARQUE SANTA MARIA"] <- "CANINDEZINHO"


##AGRUPAR DADOS ELEICOES POR BAIRRO ELEITORES, VOTOS E RELACAO ELEITOR VOTO##

candi_total <- candi2 %>%
  group_by(name_neighborhood) %>%
    summarise(Eleitores = sum(`Qtde. de Eleitores Aptos`), Votos = sum(QT_VOTOS, na.rm =TRUE))

candi_total$Voto_por_eleitor <- candi_total$Votos/candi_total$Eleitores*1000



##FILTRANDO SOMENTE COLUNAS RELEVANTES DO IBGE, OU SEJA, BAIRROS E LOCALIZACAO##

nei_fortal2 <- subset(nei_fortal, select = c(name_neighborhood, geom))
nei_fortal2 <- unique(nei_fortal2, by=name_neighborhood)

##UNINDO IBGE E DADOS ELEITORAIS##

mapinha <- inner_join(nei_fortal2,candi_total, by="name_neighborhood")

##CONFERINDO TOTAL DE VOTOS QUE SERAO PLOTADOS##


tvotos <- sum(mapinha$Votos, na.rm=TRUE)

cat("**Candidato(a):**", i, "\n\n")

cat ("**Total de Votos:**", tvotos)


##COLOCANDO O NOME DO VEREADOR E QUANTIDADE DE VOTOS

tabela_plot<-data.frame(mapinha$name_neighborhood, mapinha$Votos, mapinha$Eleitores, mapinha$Voto_por_eleitor)
colnames(tabela_plot)[1] <- "Bairro"
colnames(tabela_plot)[2]<- "Total de votos"
colnames(tabela_plot)[3]<- "Eleitores aptos"
colnames(tabela_plot)[4]<- "Votos a cada mil eleitores"

##PLOTANDO MAPA DE VOTOS##


mapavotos <- ggplot(mapinha)+
  geom_sf(aes(fill=Votos))+ 
  geom_sf(data=fortal, fill='transparent')+
  geom_sf_text(aes(label = name_neighborhood), size=2.5,colour = "grey8")+
  scale_colour_gradientn(colours=brewer.pal(9,'YlGn'))+
  scale_fill_gradientn(colours=brewer.pal(9,'YlGn'))+
  labs(title=i, 
       subtitle = "TOTAL DE VOTOS", 
       fill= "Total de votos")+
  labs(x= NULL, y=NULL)+
  theme_classic(base_size=20)


maparelativo <- ggplot(mapinha)+
  geom_sf(aes(fill=Voto_por_eleitor))+ 
  geom_sf(data=fortal, fill='transparent')+
  geom_sf_text(aes(label = name_neighborhood, position="identity"), size=2.5,colour = "grey8")+
  scale_colour_gradientn(colours=brewer.pal(9,'Oranges'))+
  scale_fill_gradientn(colours=brewer.pal(9,'Oranges'))+
  labs( title = i, 
        subtitle = "VOTOS A CADA MIL ELEITORES",
        fill= "Votos relativos")+
  labs(x= NULL, y=NULL)+
  theme_classic(base_size=20)

##PLOTANDO O RESULTADO RELATIVO A QUANTIDADE DE ELEITORES##

print(mapavotos)

print(maparelativo)

##PLOTANDO TABELA##

mapinha$Voto_por_eleitor <- round(mapinha$Voto_por_eleitor, digits=2)

mapinha <- arrange(mapinha, desc(Votos))

tabela_plot<-data.frame(mapinha$name_neighborhood, mapinha$Votos, mapinha$Eleitores, mapinha$Voto_por_eleitor)
colnames(tabela_plot)[1] <-"Bairro"
colnames(tabela_plot)[2]<- "Total de votos"
colnames(tabela_plot)[3]<- "Eleitores aptos"
colnames(tabela_plot)[4]<- "Votos a cada mil eleitores"


##cat("**Votação detalhada**","\n\n" )  
##cat(i)


tabelaplot <- tabela_plot %>% 
knitr::kable() %>%
kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover", "condensed", "responsive"))

print(tabelaplot)

  }


```

## Fontes de dados

Tribunal Superior Eleitoral (TSE)  
Tribunal Regional Eleitoral (TRE) - CE   
Instituto Brasileiro de Geografia e Estatística - IBGE   
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
